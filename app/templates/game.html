{% extends "layout.html" %}

{% block title %}New Level - Игровое обучение{% endblock %}

{% block additional_styles %}
:root {
  --correct: #4CAF50;
  --incorrect: #F44336;
}

.game-container {
  margin-top: 100px;
  padding-bottom: 60px;
}

.stats-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: white;
  padding: 15px 25px;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  margin-bottom: 30px;
}

.points {
  display: flex;
  align-items: center;
  gap: 10px;
}

.points-icon {
  color: gold;
  font-size: 24px;
}

.points-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--accent);
}

.level {
  text-align: center;
}

.level-title {
  font-size: 14px;
  color: #777;
  margin-bottom: 5px;
}

.level-progress {
  width: 250px;
  height: 10px;
  background-color: #e0e0e0;
  border-radius: 5px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(to right, var(--secondary), var(--primary));
  border-radius: 5px;
  transition: width 0.3s ease;
}

.level-info {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #777;
  margin-top: 5px;
}

.game-wrapper {
  background-color: white;
  border-radius: 15px;
  padding: 30px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.06);
  margin-bottom: 30px;
}

.game-title {
  text-align: center;
  color: var(--secondary);
  margin-bottom: 20px;
  font-size: 26px;
}

.game-selector {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-bottom: 25px;
}

.game-tab {
  background-color: var(--bg-light);
  color: var(--secondary);
  border: none;
  padding: 10px 20px;
  border-radius: 30px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-weight: 500;
}

.game-tab.active {
  background-color: var(--secondary);
  color: white;
}

.game-tab:hover {
  background-color: var(--accent);
  color: white;
}

.question-container {
  margin-bottom: 30px;
}

.question {
  font-size: 20px;
  margin-bottom: 15px;
  color: #333;
}

.scramble-container {
  text-align: center;
  margin-top: 20px;
}

.scrambled-word {
  font-size: 28px;
  font-weight: bold;
  color: var(--secondary);
  letter-spacing: 5px;
  margin-bottom: 20px;
}

.scramble-input {
  padding: 12px;
  font-size: 18px;
  width: 100%;
  max-width: 300px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  margin-bottom: 15px;
  text-align: center;
}

.scramble-input:focus {
  border-color: var(--primary);
  outline: none;
}

.word-pair {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-bottom: 20px;
}

.word-drop {
  min-width: 150px;
  min-height: 50px;
  border: 2px dashed var(--secondary);
  border-radius: 8px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.word-item {
  background-color: var(--bg-light);
  padding: 10px 15px;
  border-radius: 5px;
  cursor: move;
  margin: 5px;
  display: inline-block;
  user-select: none;
}

.word-bank {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-top: 30px;
}

.typing-game input {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  margin-top: 20px;
  margin-bottom: 15px;
}

.typing-game input:focus {
  border-color: var(--accent);
  outline: none;
}

.check-btn {
  background-color: var(--secondary);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: block;
  margin: 0 auto;
}

.check-btn:hover {
  background-color: var(--primary);
}

.feedback {
  text-align: center;
  margin: 20px 0;
  font-size: 18px;
  font-weight: 600;
  min-height: 27px;
}

.next-btn {
  background-color: var(--secondary);
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: block;
  margin: 0 auto;
  font-size: 16px;
}

.next-btn:hover {
  background-color: var(--primary);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.game-info {
  background-color: white;
  border-radius: 15px;
  padding: 30px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.06);
}

.game-info h3 {
  color: var(--secondary);
  margin-bottom: 15px;
}

.game-info-section {
  margin-bottom: 20px;
}

.game-info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}

.reward-animation {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 100;
  display: flex;
  justify-content: center;
  align-items: center;
}

.stars {
  position: absolute;
  font-size: 30px;
  color: gold;
  animation: star-fall 1.5s ease-out forwards;
}

@keyframes star-fall {
  0% {
      transform: translateY(-50px) scale(0);
      opacity: 0;
  }
  50% {
      opacity: 1;
      transform: translateY(0) scale(1.2);
  }
  100% {
      transform: translateY(20px) scale(1);
      opacity: 0;
  }
}

/* Скрываем игры по умолчанию */
#scramble-game, #matching-game, #typing-game {
  display: none;
}

/* Показываем активную игру */
.game-active {
  display: block !important;
}

/* Стили для кнопок правильных и неправильных ответов */
.correct {
  color: var(--correct);
}

.incorrect {
  color: var(--incorrect);
}
{% endblock %}

{% block content %}
<div class="container game-container">
  <div class="stats-bar">
    <div class="points">
      <div class="points-icon">
        <i class="fas fa-star"></i>
      </div>
      <div class="points-value" id="points-display">{{ user.total_points }}</div>
    </div>
    
    <div class="level">
      <div class="level-title">ПРОГРЕСС УРОВНЯ</div>
      <div class="level-progress">
        <div class="progress-bar" id="level-progress-bar" style="width: {{ progress_percent }}%;"></div>
      </div>
      <div class="level-info">
        <span>Уровень {{ user.level }}</span>
        <span>Уровень {{ user.level + 1 }}</span>
      </div>
    </div>
  </div>
  
  <div class="game-wrapper">
    <h2 class="game-title">Игровой центр английского языка</h2>
    
    <div class="game-selector">
      <button class="game-tab active" data-game="scramble">Анаграммы</button>
      <button class="game-tab" data-game="matching">Сопоставление</button>
      <button class="game-tab" data-game="typing">Написание слов</button>
    </div>
    
    <div id="scramble-game" class="game-active">
      <div class="question-container">
        <p class="question">Расшифруйте английское слово из перемешанных букв:</p>
        
        <div class="scramble-container">
          <div class="scrambled-word" id="scrambled-word">ЗАГРУЗКА...</div>
          <input type="text" class="scramble-input" id="scramble-input" placeholder="Введите ответ">
          <button class="check-btn" id="scramble-check-btn">Проверить</button>
        </div>
      </div>
    </div>
    
    <div id="matching-game">
      <div class="question-container">
        <p class="question">Соедините английские слова с их русскими эквивалентами:</p>
        
        <div id="matching-pairs">
          <!-- Сюда будут динамически добавляться пары для сопоставления -->
        </div>
        
        <div class="word-bank" id="matching-word-bank">
          <!-- Сюда будут динамически добавляться слова для перетаскивания -->
        </div>
      </div>
    </div>
    
    <div id="typing-game">
      <div class="question-container typing-game">
        <p class="question" id="typing-question">ЗАГРУЗКА...</p>
        <input type="text" id="typing-input" placeholder="Введите слово...">
        <button class="check-btn" id="typing-check-btn">Проверить</button>
      </div>
    </div>
    
    <div class="feedback" id="feedback"></div>
    
    <button class="next-btn" id="next-btn" style="display: none;">Следующий вопрос</button>
  </div>
  
  <div class="game-info">
    <div class="game-info-section">
      <h3>Об играх</h3>
      <div class="game-info-grid">
        <div>
          <h4>Анаграммы</h4>
          <p>Разгадайте английское слово из перемешанных букв. Тренирует навыки орфографии и расширяет словарный запас.</p>
        </div>
        <div>
          <h4>Сопоставление</h4>
          <p>Перетащите русские слова, чтобы сопоставить их с английскими эквивалентами. Отличный способ расширить словарный запас.</p>
        </div>
        <div>
          <h4>Написание слов</h4>
          <p>Напишите английское слово по его описанию. Развивает навыки правописания и ассоциативное мышление.</p>
        </div>
      </div>
    </div>
    
    <div class="game-info-section">
      <h3>Игровая механика</h3>
      <p>За каждый правильный ответ вы получаете {{ settings.points_per_answer|default('10') }} очков. Заработанные очки увеличивают ваш прогресс к следующему уровню. Каждый уровень открывает новые задания и более сложные слова. Совершенствуйте свой английский, играя и соревнуясь с друзьями!</p>
      <p>Наша база содержит более 1000 слов и выражений, охватывающих различные темы и уровни владения языком. База постоянно пополняется новыми словами и заданиями.</p>
    </div>
  </div>
</div>

<div class="reward-animation" id="reward-animation"></div>
{% endblock %}

{% block scripts %}
<script>
  // Глобальные переменные для игр
  let currentGame = "scramble";
  let currentWords = [];
  let currentWordIndex = 0;
  let gameSession = null;
  let score = 0;
  let correctAnswers = 0;
  let totalQuestions = 0;

  // DOM-элементы
  const gameTabs = document.querySelectorAll('.game-tab');
  const gameContainers = document.querySelectorAll('#scramble-game, #matching-game, #typing-game');
  const nextButton = document.getElementById('next-btn');
  const feedbackElement = document.getElementById('feedback');
  const pointsDisplay = document.getElementById('points-display');
  const progressBar = document.getElementById('level-progress-bar');

  // Обработчики для игры "Анаграммы"
  const scrambledWordElement = document.getElementById('scrambled-word');
  const scrambleInput = document.getElementById('scramble-input');
  const scrambleCheckBtn = document.getElementById('scramble-check-btn');

  // Обработчики для игры "Написание слов"
  const typingQuestion = document.getElementById('typing-question');
  const typingInput = document.getElementById('typing-input');
  const typingCheckBtn = document.getElementById('typing-check-btn');

  // Инициализация при загрузке страницы
  document.addEventListener('DOMContentLoaded', () => {
    loadGame('scramble');
    
    // Обработчики событий для кнопок игр
    gameTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        gameTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const gameType = tab.dataset.game;
        currentGame = gameType;
        
        // Скрываем все игры и показываем выбранную
        gameContainers.forEach(container => {
          container.classList.remove('game-active');
        });
        document.getElementById(`${gameType}-game`).classList.add('game-active');
        
        // Загружаем новую игру
        loadGame(gameType);
      });
    });
    
    // Обработчик для кнопки "Следующий вопрос"
    nextButton.addEventListener('click', () => {
      nextQuestion();
    });
    
    // Обработчики для проверки ответов
    scrambleCheckBtn.addEventListener('click', () => {
      checkScrambleAnswer();
    });
    
    typingCheckBtn.addEventListener('click', () => {
      checkTypingAnswer();
    });
    
    // Обработка нажатия Enter в полях ввода
    scrambleInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        checkScrambleAnswer();
      }
    });
    
    typingInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        checkTypingAnswer();
      }
    });
  });
  
  // Запуск новой игровой сессии
  async function startGameSession(gameType) {
    try {
      const response = await fetch('/api/game/start', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ game_type: gameType }),
      });
      
      const data = await response.json();
      gameSession = data.session_id;
      score = 0;
      correctAnswers = 0;
      totalQuestions = 0;
      
      console.log(`Начата новая игровая сессия: ${gameSession}`);
    } catch (error) {
      console.error('Ошибка при создании игровой сессии:', error);
    }
  }
  
  // Загрузка слов для игры
  async function loadWordsForGame(gameType) {
    try {
      const response = await fetch(`/api/words/${gameType}?count=5`);
      const data = await response.json();
      
      currentWords = data;
      currentWordIndex = 0;
      
      console.log(`Загружено ${currentWords.length} слов для игры ${gameType}`);
      
      return data;
    } catch (error) {
      console.error('Ошибка при загрузке слов:', error);
      return [];
    }
  }
  
  // Загрузка игры
  async function loadGame(gameType) {
    // Сбрасываем UI
    feedbackElement.textContent = '';
    feedbackElement.className = 'feedback';
    nextButton.style.display = 'none';
    
    // Запускаем новую игровую сессию
    await startGameSession(gameType);
    
    // Загружаем слова
    await loadWordsForGame(gameType);
    
    // Показываем первый вопрос
    showCurrentQuestion();
  }
  
  // Показать текущий вопрос
  function showCurrentQuestion() {
    if (!currentWords || currentWords.length === 0 || currentWordIndex >= currentWords.length) {
      console.error('Нет доступных слов для отображения');
      return;
    }
    
    const word = currentWords[currentWordIndex];
    
    // Очищаем поля ввода и сообщения
    scrambleInput.value = '';
    typingInput.value = '';
    feedbackElement.textContent = '';
    feedbackElement.className = 'feedback';
    nextButton.style.display = 'none';
    
    // Показываем соответствующий вопрос в зависимости от типа игры
    if (currentGame === 'scramble') {
      scrambledWordElement.textContent = word.scrambled;
    } else if (currentGame === 'matching') {
      setupMatchingGame();
    } else if (currentGame === 'typing') {
      typingQuestion.textContent = word.description;
    }
  }
  
  // Обработка ответа для игры "Анаграммы"
  function checkScrambleAnswer() {
    const word = currentWords[currentWordIndex];
    const userAnswer = scrambleInput.value.trim().toLowerCase();
    const correctAnswer = word.text.toLowerCase();
    
    checkAnswer(userAnswer, correctAnswer, word.id);
  }
  
  // Обработка ответа для игры "Написание слов"
  function checkTypingAnswer() {
    const word = currentWords[currentWordIndex];
    const userAnswer = typingInput.value.trim().toLowerCase();
    const correctAnswer = word.text.toLowerCase();
    
    checkAnswer(userAnswer, correctAnswer, word.id);
  }
  
  // Общая функция проверки ответа
  async function checkAnswer(userAnswer, correctAnswer, wordId) {
    totalQuestions++;
    
    // Отправляем ответ на сервер для проверки
    try {
      const response = await fetch('/api/word/check', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ word_id: wordId, answer: userAnswer }),
      });
      
      const data = await response.json();
      
      // Обрабатываем результат
      if (data.correct) {
        correctAnswers++;
        score += 10;
        
        feedbackElement.textContent = 'Правильно! +10 очков';
        feedbackElement.className = 'feedback correct';
        
        // Анимация награды
        showRewardAnimation();
      } else {
        feedbackElement.textContent = `Неверно. Правильный ответ: ${correctAnswer}`;
        feedbackElement.className = 'feedback incorrect';
      }
      
      // Показываем кнопку следующего вопроса
      nextButton.style.display = 'block';
    } catch (error) {
      console.error('Ошибка при проверке ответа:', error);
    }
  }
  
  // Переход к следующему вопросу
  function nextQuestion() {
    currentWordIndex++;
    
    // Если слова закончились, завершаем игру
    if (currentWordIndex >= currentWords.length) {
      finishGame();
    } else {
      // Показываем следующий вопрос
      showCurrentQuestion();
    }
  }
  
  // Завершение игры и отправка результатов
  async function finishGame() {
    try {
      const response = await fetch('/api/game/end', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          session_id: gameSession,
          score: score,
          correct_answers: correctAnswers,
          total_questions: totalQuestions
        }),
      });
      
      const data = await response.json();
      
      // Обновляем UI с результатами
      feedbackElement.textContent = `Игра завершена! Вы набрали ${score} очков. +${data.experience_gained} к опыту!`;
      feedbackElement.className = 'feedback';
      
      // Скрываем кнопку "Следующий вопрос"
      nextButton.style.display = 'none';
      
      // Обновляем отображение очков и прогресса
      pointsDisplay.textContent = parseInt(pointsDisplay.textContent) + data.experience_gained;
      
      // Если произошло повышение уровня
      if (data.level_up) {
        setTimeout(() => {
          alert(`Поздравляем! Вы достигли уровня ${data.level}!`);
          // Перезагружаем страницу для обновления данных
          window.location.reload();
        }, 1500);
      }
      
      // Загружаем новую игру через 3 секунды
      setTimeout(() => {
        loadGame(currentGame);
      }, 3000);
      
    } catch (error) {
      console.error('Ошибка при завершении игры:', error);
    }
  }
  
  // Настройка игры "Сопоставление"
  function setupMatchingGame() {
    // Функционал для перетаскивания слов между контейнерами
    // Для этой игры требуется дополнительная обработка HTML5 Drag and Drop API
    
    const matchingPairsContainer = document.getElementById('matching-pairs');
    const matchingWordBank = document.getElementById('matching-word-bank');
    
    // Очищаем контейнеры
    matchingPairsContainer.innerHTML = '';
    matchingWordBank.innerHTML = '';
    
    // Создаем пары слов
    const word = currentWords[currentWordIndex];
    const englishText = word.text;
    const translationText = word.translation;
    
    // Создаем пару слов
    const pair = document.createElement('div');
    pair.className = 'word-pair';
    pair.innerHTML = `
      <div class="word-item">${englishText}</div>
      <div class="word-drop" id="drop1" ondrop="dropWord(event)" ondragover="allowDrop(event)"></div>
    `;
    matchingPairsContainer.appendChild(pair);
    
    // Создаем перетаскиваемый элемент
    const dragItem = document.createElement('div');
    dragItem.className = 'word-item';
    dragItem.draggable = true;
    dragItem.setAttribute('ondragstart', 'dragWord(event)');
    dragItem.setAttribute('data-match', 'drop1');
    dragItem.setAttribute('data-answer', translationText);
    dragItem.textContent = translationText;
    
    matchingWordBank.appendChild(dragItem);
    
    // Добавляем еще несколько вариантов для усложнения игры
    // В реальном сценарии эти слова должны приходить с сервера
    const distractors = ['кошка', 'собака', 'дом', 'книга', 'яблоко'];
    
    for (let i = 0; i < 2; i++) {
      const distractor = document.createElement('div');
      distractor.className = 'word-item';
      distractor.draggable = true;
      distractor.setAttribute('ondragstart', 'dragWord(event)');
      distractor.setAttribute('data-match', 'drop1');
      distractor.setAttribute('data-answer', distractors[i]);
      distractor.textContent = distractors[i];
      
      matchingWordBank.appendChild(distractor);
    }
    
    // Добавляем глобальные функции для работы с Drag and Drop
    window.dragWord = function(event) {
      event.dataTransfer.setData('text', event.target.getAttribute('data-answer'));
    };
    
    window.allowDrop = function(event) {
      event.preventDefault();
    };
    
    window.dropWord = function(event) {
      event.preventDefault();
      const data = event.dataTransfer.getData('text');
      
      // Добавляем перетаскиваемый элемент в зону
      const items = document.querySelectorAll(`[data-answer="${data}"]`);
      if (items.length > 0) {
        const item = items[0].cloneNode(true);
        event.target.innerHTML = '';
        event.target.appendChild(item);
        
        // Убираем возможность перетаскивания
        item.draggable = false;
        
        // Проверяем ответ
        checkMatchingAnswer(data);
      }
    };
  }
  
  // Проверка ответа в игре "Сопоставление"
  function checkMatchingAnswer(answer) {
    const word = currentWords[currentWordIndex];
    const correctAnswer = word.translation.toLowerCase();
    const userAnswer = answer.toLowerCase();
    
    checkAnswer(userAnswer, correctAnswer, word.id);
  }
  
  // Анимация для награды
  function showRewardAnimation() {
    const rewardContainer = document.getElementById('reward-animation');
    
    for (let i = 0; i < 10; i++) {
      const star = document.createElement('div');
      star.className = 'stars';
      star.innerHTML = '<i class="fas fa-star"></i>';
      star.style.left = Math.random() * 100 + 'vw';
      star.style.animationDelay = Math.random() * 0.5 + 's';
      rewardContainer.appendChild(star);
      
      // Убрать звезды после анимации
      setTimeout(() => {
        star.remove();
      }, 2000);
    }
  }
</script>
{% endblock %}
