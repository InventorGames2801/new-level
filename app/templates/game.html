{% extends "layout.html" %} {% block title %}New Level - Игровое обучение{%
endblock %} {% block additional_styles %} :root { --correct: #4CAF50;
--incorrect: #F44336; } .game-container { margin-top: 100px; padding-bottom:
60px; } .stats-bar { display: flex; justify-content: space-between; align-items:
center; background-color: white; padding: 15px 25px; border-radius: 10px;
box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; } .points {
display: flex; align-items: center; gap: 10px; } .points-icon { color: gold;
font-size: 24px; } .points-value { font-size: 24px; font-weight: 700; color:
var(--accent); } .level { text-align: center; } .level-title { font-size: 14px;
color: #777; margin-bottom: 5px; } .level-progress { width: 250px; height: 10px;
background-color: #e0e0e0; border-radius: 5px; overflow: hidden; } .progress-bar
{ height: 100%; background: linear-gradient(to right, var(--secondary),
var(--primary)); border-radius: 5px; transition: width 0.3s ease; } .level-info
{ display: flex; justify-content: space-between; font-size: 12px; color: #777;
margin-top: 5px; } .game-wrapper { background-color: white; border-radius: 15px;
padding: 30px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); margin-bottom: 30px; }
.game-title { text-align: center; color: var(--secondary); margin-bottom: 20px;
font-size: 26px; } .game-selector { display: flex; justify-content: center; gap:
15px; margin-bottom: 25px; } .game-tab { background-color: var(--bg-light);
color: var(--secondary); border: none; padding: 10px 20px; border-radius: 30px;
cursor: pointer; transition: all 0.2s ease; font-weight: 500; } .game-tab.active
{ background-color: var(--secondary); color: white; } .game-tab:hover {
background-color: var(--accent); color: white; } .question-container {
margin-bottom: 30px; } .question { font-size: 20px; margin-bottom: 15px; color:
#333; } .scramble-container { text-align: center; margin-top: 20px; }
.scrambled-word { font-size: 28px; font-weight: bold; color: var(--secondary);
letter-spacing: 5px; margin-bottom: 20px; } .scramble-input { padding: 12px;
font-size: 18px; width: 100%; max-width: 300px; border: 2px solid #e0e0e0;
border-radius: 8px; margin-bottom: 15px; text-align: center; }
.scramble-input:focus { border-color: var(--primary); outline: none; }
.word-pair { display: flex; justify-content: center; gap: 20px; margin-bottom:
20px; } .word-drop { min-width: 150px; min-height: 50px; border: 2px dashed
var(--secondary); border-radius: 8px; display: flex; justify-content: center;
align-items: center; transition: all 0.3s ease; } .word-drop.correct-match {
border-color: var(--correct); background-color: rgba(76, 175, 80, 0.1); }
.word-drop.incorrect-match { border-color: var(--incorrect); background-color:
rgba(244, 67, 54, 0.1); } .word-item { background-color: var(--bg-light);
padding: 10px 15px; border-radius: 5px; cursor: move; margin: 5px; display:
inline-block; user-select: none; } .word-bank { display: flex; flex-wrap: wrap;
justify-content: center; gap: 10px; margin-top: 30px; } .typing-game input {
width: 100%; padding: 12px; font-size: 16px; border: 2px solid #e0e0e0;
border-radius: 8px; margin-top: 20px; margin-bottom: 15px; } .typing-game
input:focus { border-color: var(--accent); outline: none; } .check-btn {
background-color: var(--secondary); color: white; border: none; padding: 10px
20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all
0.3s ease; display: block; margin: 0 auto; } .check-btn:hover {
background-color: var(--primary); } .feedback { text-align: center; margin: 20px
0; font-size: 18px; font-weight: 600; min-height: 27px; } .next-btn {
background-color: var(--secondary); color: white; border: none; padding: 12px
25px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all
0.3s ease; display: block; margin: 0 auto; font-size: 16px; } .next-btn:hover {
background-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px
8px rgba(0,0,0,0.1); } .game-info { background-color: white; border-radius:
15px; padding: 30px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); } .game-info h3 {
color: var(--secondary); margin-bottom: 15px; } .game-info-section {
margin-bottom: 20px; } .game-info-grid { display: grid; grid-template-columns:
repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; } .reward-animation { position:
fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
z-index: 100; display: flex; justify-content: center; align-items: center; }
.stars { position: absolute; font-size: 30px; color: gold; animation: star-fall
1.5s ease-out forwards; } @keyframes star-fall { 0% { transform:
translateY(-50px) scale(0); opacity: 0; } 50% { opacity: 1; transform:
translateY(0) scale(1.2); } 100% { transform: translateY(20px) scale(1);
opacity: 0; } } /* Скрываем игры по умолчанию */ #scramble-game, #matching-game,
#typing-game { display: none; } /* Показываем активную игру */ .game-active {
display: block !important; } /* Стили для кнопок правильных и неправильных
ответов */ .correct { color: var(--correct); } .incorrect { color:
var(--incorrect); } /* Стили для кнопок подсказки и пропуска */ .hint-btn,
.skip-btn { padding: 8px 15px; border: none; border-radius: 5px; cursor:
pointer; font-weight: 500; transition: all 0.3s ease; font-size: 14px; display:
inline-block; margin: 0 5px; } .hint-btn { background-color: #FBC02D; color:
#5D4037; } .hint-btn:hover { background-color: #F9A825; transform:
translateY(-2px); } .skip-btn { background-color: #E0E0E0; color: #555; }
.skip-btn:hover { background-color: #BDBDBD; transform: translateY(-2px); }
.action-buttons { display: flex; justify-content: center; gap: 15px; margin:
15px 0; } {% endblock %} {% block content %}
<div class="container game-container">
  <div class="stats-bar">
    <div class="points">
      <div class="points-icon">
        <i class="fas fa-star"></i>
      </div>
      <div class="points-value" id="points-display">
        {{ user.total_points }}
      </div>
    </div>

    <div class="level">
      <div class="level-title">ПРОГРЕСС УРОВНЯ</div>
      <div class="level-progress">
        <div
          class="progress-bar"
          id="level-progress-bar"
          style="width: {{ progress_percent }}%;"
        ></div>
      </div>
      <div class="level-info">
        <span>Уровень {{ user.level }}</span>
        <span>Уровень {{ user.level + 1 }}</span>
      </div>
    </div>
  </div>

  <div class="game-wrapper">
    <h2 class="game-title">Игровой центр английского языка</h2>

    <div class="game-selector">
      <button class="game-tab active" data-game="scramble">Анаграммы</button>
      <button class="game-tab" data-game="matching">Сопоставление</button>
      <button class="game-tab" data-game="typing">Написание слов</button>
    </div>

    <div id="scramble-game" class="game-active">
      <div class="question-container">
        <p class="question">
          Расшифруйте английское слово из перемешанных букв:
        </p>

        <div class="scramble-container">
          <div class="scrambled-word" id="scrambled-word">ЗАГРУЗКА...</div>
          <input
            type="text"
            class="scramble-input"
            id="scramble-input"
            placeholder="Введите ответ"
          />
          <button class="check-btn" id="scramble-check-btn">Проверить</button>
        </div>
      </div>
    </div>

    <div id="matching-game">
      <div class="question-container">
        <p class="question">
          Соедините английские слова с их русскими эквивалентами:
        </p>

        <div id="matching-pairs">
          <!-- Сюда будут динамически добавляться пары для сопоставления -->
        </div>

        <div class="word-bank" id="matching-word-bank">
          <!-- Сюда будут динамически добавляться слова для перетаскивания -->
        </div>
      </div>
    </div>

    <div id="typing-game">
      <div class="question-container typing-game">
        <p class="question" id="typing-question">ЗАГРУЗКА...</p>
        <input type="text" id="typing-input" placeholder="Введите слово..." />
        <button class="check-btn" id="typing-check-btn">Проверить</button>
      </div>
    </div>

    <div class="feedback" id="feedback"></div>

    <div class="action-buttons">
      <button id="hint-btn" class="hint-btn">Подсказка</button>
      <button id="skip-btn" class="skip-btn">Пропустить</button>
    </div>

    <button class="next-btn" id="next-btn" style="display: none">
      Следующий вопрос
    </button>
  </div>

  <div class="game-info">
    <div class="game-info-section">
      <h3>Об играх</h3>
      <div class="game-info-grid">
        <div>
          <h4>Анаграммы</h4>
          <p>
            Разгадайте английское слово из перемешанных букв. Тренирует навыки
            орфографии и расширяет словарный запас.
          </p>
        </div>
        <div>
          <h4>Сопоставление</h4>
          <p>
            Перетащите русские слова, чтобы сопоставить их с английскими
            эквивалентами. Отличный способ расширить словарный запас.
          </p>
        </div>
        <div>
          <h4>Написание слов</h4>
          <p>
            Напишите английское слово по его описанию. Развивает навыки
            правописания и ассоциативное мышление.
          </p>
        </div>
      </div>
    </div>

    <div class="game-info-section">
      <h3>Игровая механика</h3>
      <p>
        За каждый правильный ответ вы получаете {{
        settings.points_per_answer|default('10') }} очков. Заработанные очки
        увеличивают ваш прогресс к следующему уровню. Каждый уровень открывает
        новые задания и более сложные слова.
      </p>
      <p>
        Если вам сложно, вы можете использовать подсказку или пропустить вопрос.
        При использовании подсказки в режимах анаграмм и написания слов будет
        показана первая половина слова, а в режиме сопоставления будет
        автоматически установлена одна правильная пара.
      </p>
    </div>
  </div>
</div>

<div class="reward-animation" id="reward-animation"></div>
{% endblock %} {% block scripts %}
<script>
  // Глобальные переменные для игр
  let currentGame = "scramble";
  let currentWords = [];
  let currentWordIndex = 0;
  let gameSession = null;
  let score = 0;
  let correctAnswers = 0;
  let totalQuestions = 0;

  // DOM-элементы
  const gameTabs = document.querySelectorAll(".game-tab");
  const gameContainers = document.querySelectorAll(
    "#scramble-game, #matching-game, #typing-game"
  );
  const nextButton = document.getElementById("next-btn");
  const feedbackElement = document.getElementById("feedback");
  const pointsDisplay = document.getElementById("points-display");
  const progressBar = document.getElementById("level-progress-bar");
  const hintBtn = document.getElementById("hint-btn");
  const skipBtn = document.getElementById("skip-btn");

  // Обработчики для игры "Анаграммы"
  const scrambledWordElement = document.getElementById("scrambled-word");
  const scrambleInput = document.getElementById("scramble-input");
  const scrambleCheckBtn = document.getElementById("scramble-check-btn");

  // Обработчики для игры "Написание слов"
  const typingQuestion = document.getElementById("typing-question");
  const typingInput = document.getElementById("typing-input");
  const typingCheckBtn = document.getElementById("typing-check-btn");

  // Инициализация при загрузке страницы
  document.addEventListener("DOMContentLoaded", () => {
    loadGame("scramble");

    // Обработчики событий для кнопок игр
    gameTabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        gameTabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");

        const gameType = tab.dataset.game;
        currentGame = gameType;

        // Скрываем все игры и показываем выбранную
        gameContainers.forEach((container) => {
          container.classList.remove("game-active");
        });
        document
          .getElementById(`${gameType}-game`)
          .classList.add("game-active");

        // Загружаем новую игру
        loadGame(gameType);
      });
    });

    // Обработчик для кнопки "Следующий вопрос"
    nextButton.addEventListener("click", () => {
      nextQuestion();
    });

    // Обработчики для проверки ответов
    scrambleCheckBtn.addEventListener("click", () => {
      checkScrambleAnswer();
    });

    typingCheckBtn.addEventListener("click", () => {
      checkTypingAnswer();
    });

    // Обработка нажатия Enter в полях ввода
    scrambleInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        checkScrambleAnswer();
      }
    });

    typingInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        checkTypingAnswer();
      }
    });

    // Обработчик для кнопки подсказки
    hintBtn.addEventListener("click", () => {
      useHint();
    });

    // Обработчик для кнопки пропуска
    skipBtn.addEventListener("click", () => {
      skipQuestion();
    });
  });

  // Запуск новой игровой сессии
  async function startGameSession(gameType) {
    try {
      const response = await fetch("/api/game/start", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ game_type: gameType }),
      });

      const data = await response.json();
      gameSession = data.session_id;
      score = 0;
      correctAnswers = 0;
      totalQuestions = 0;

      console.log(`Начата новая игровая сессия: ${gameSession}`);
    } catch (error) {
      console.error("Ошибка при создании игровой сессии:", error);
    }
  }

  // Загрузка слов для игры
  async function loadWordsForGame(gameType) {
    try {
      // Для игры с сопоставлением загружаем больше слов
      const count = gameType === "matching" ? 3 : 5;

      const response = await fetch(`/api/words/${gameType}?count=${count}`);
      const data = await response.json();

      currentWords = data;
      currentWordIndex = 0;

      console.log(`Загружено ${currentWords.length} слов для игры ${gameType}`);

      return data;
    } catch (error) {
      console.error("Ошибка при загрузке слов:", error);
      return [];
    }
  }

  // Загрузка игры
  async function loadGame(gameType) {
    // Сбрасываем UI
    feedbackElement.textContent = "";
    feedbackElement.className = "feedback";
    nextButton.style.display = "none";
    hintBtn.style.display = "block";
    skipBtn.style.display = "block";

    // Запускаем новую игровую сессию
    await startGameSession(gameType);

    // Загружаем слова
    await loadWordsForGame(gameType);

    // Показываем первый вопрос
    showCurrentQuestion();
  }

  // Показать текущий вопрос
  function showCurrentQuestion() {
    if (
      !currentWords ||
      currentWords.length === 0 ||
      currentWordIndex >= currentWords.length
    ) {
      console.error("Нет доступных слов для отображения");
      return;
    }

    // Очищаем поля ввода и сообщения
    scrambleInput.value = "";
    typingInput.value = "";
    feedbackElement.textContent = "";
    feedbackElement.className = "feedback";
    nextButton.style.display = "none";

    // Разблокируем поля ввода
    scrambleInput.disabled = false;
    scrambleCheckBtn.disabled = false;
    typingInput.disabled = false;
    typingCheckBtn.disabled = false;

    // Показываем соответствующий вопрос в зависимости от типа игры
    if (currentGame === "scramble") {
      const word = currentWords[currentWordIndex];
      scrambledWordElement.textContent = word.scrambled;
    } else if (currentGame === "matching") {
      setupMatchingGame();
    } else if (currentGame === "typing") {
      const word = currentWords[currentWordIndex];
      typingQuestion.textContent = word.description;
    }

    // Показываем кнопки
    hintBtn.style.display = "block";
    skipBtn.style.display = "block";
  }

  // Обработка ответа для игры "Анаграммы"
  function checkScrambleAnswer() {
    if (scrambleInput.disabled) return; // Предотвращаем повторную проверку

    const word = currentWords[currentWordIndex];
    const userAnswer = scrambleInput.value.trim().toLowerCase();

    checkAnswer(userAnswer, word.id);
  }

  // Обработка ответа для игры "Написание слов"
  function checkTypingAnswer() {
    if (typingInput.disabled) return; // Предотвращаем повторную проверку

    const word = currentWords[currentWordIndex];
    const userAnswer = typingInput.value.trim().toLowerCase();

    checkAnswer(userAnswer, word.id);
  }

  // Общая функция проверки ответа
  async function checkAnswer(userAnswer, wordId) {
    try {
      const response = await fetch("/api/word/check", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ word_id: wordId, answer: userAnswer }),
      });

      const data = await response.json();

      // Обрабатываем результат
      if (data.correct) {
        // Правильный ответ
        correctAnswers++;
        totalQuestions++;

        // Начисляем очки
        score += 10;

        feedbackElement.textContent = `Правильно! +10 очков`;
        feedbackElement.className = "feedback correct";

        // Анимация награды
        showRewardAnimation();

        // Блокируем поля ввода
        disableInputs();

        // Показываем кнопку следующего вопроса
        nextButton.style.display = "block";

        // Скрываем кнопки
        hintBtn.style.display = "none";
        skipBtn.style.display = "none";
      } else {
        // Неправильный ответ
        totalQuestions++;

        // Получаем правильный ответ
        const word = currentWords[currentWordIndex];
        let correctAnswer = "";

        if (currentGame === "scramble" || currentGame === "typing") {
          correctAnswer = word.text;
        } else if (currentGame === "matching") {
          correctAnswer = word.translation;
        }

        feedbackElement.textContent = `Неверно. Правильный ответ: ${correctAnswer}`;
        feedbackElement.className = "feedback incorrect";

        // Блокируем поля ввода
        disableInputs();

        // Сразу переходим к следующему вопросу
        setTimeout(() => {
          nextQuestion();
        }, 2000);
      }
    } catch (error) {
      console.error("Ошибка при проверке ответа:", error);
    }
  }

  // Использование подсказки
  async function useHint() {
    const word = currentWords[currentWordIndex];

    if (currentGame === "scramble") {
      // Показываем первую половину слова
      const halfLength = Math.ceil(word.text.length / 2);
      const hint = word.text.substring(0, halfLength);
      scrambleInput.value = hint;
      scrambleInput.focus();
    } else if (currentGame === "typing") {
      // Показываем первую половину слова
      const halfLength = Math.ceil(word.text.length / 2);
      const hint = word.text.substring(0, halfLength);
      typingInput.value = hint;
      typingInput.focus();
    } else if (currentGame === "matching") {
      // Для сопоставления автоматически устанавливаем одну правильную пару
      // Эта логика реализована в функции setupMatchingHint
      setupMatchingHint();
    }

    // Скрываем кнопку подсказки после использования
    hintBtn.style.display = "none";
  }

  // Функция для отображения подсказки в режиме сопоставления
  function setupMatchingHint() {
    // Находим первую пустую зону сопоставления
    const emptyDropZones = document.querySelectorAll(".word-drop:empty");
    if (emptyDropZones.length > 0) {
      const firstEmptyZone = emptyDropZones[0];
      const dropId = firstEmptyZone.id;
      const index = parseInt(dropId.replace("drop", "")) - 1;

      // Находим соответствующее русское слово
      const word = currentWords[index];
      const translationText = word.translation;

      // Находим элемент с этим переводом в банке слов
      const items = document.querySelectorAll(
        `[data-answer="${translationText}"]`
      );
      if (items.length > 0) {
        const item = items[0].cloneNode(true);
        firstEmptyZone.innerHTML = "";
        firstEmptyZone.appendChild(item);

        // Убираем возможность перетаскивания
        item.draggable = false;

        // Удаляем оригинал из банка слов
        items[0].remove();
      }
    }
  }

  // Пропуск вопроса
  function skipQuestion() {
    // Увеличиваем счетчик вопросов
    totalQuestions++;

    // Блокируем поля ввода
    disableInputs();

    // Сразу переходим к следующему вопросу
    nextQuestion();
  }

  // Функция для блокировки полей ввода
  function disableInputs() {
    if (currentGame === "scramble") {
      scrambleInput.disabled = true;
      scrambleCheckBtn.disabled = true;
    } else if (currentGame === "typing") {
      typingInput.disabled = true;
      typingCheckBtn.disabled = true;
    } else if (currentGame === "matching") {
      // Блокируем перетаскивание для режима сопоставления
      document.querySelectorAll(".word-item").forEach((item) => {
        item.draggable = false;
      });
    }

    // Скрываем кнопки
    skipBtn.style.display = "none";
    hintBtn.style.display = "none";
  }

  // Настройка игры "Сопоставление"
  function setupMatchingGame() {
    const matchingPairsContainer = document.getElementById("matching-pairs");
    const matchingWordBank = document.getElementById("matching-word-bank");

    // Очищаем контейнеры
    matchingPairsContainer.innerHTML = "";
    matchingWordBank.innerHTML = "";

    // Получаем слова для сопоставления (используем все загруженные слова)
    const words = currentWords.slice(0, 3); // Используем только 3 пары

    // Создаем пары английское слово - пустая зона для русского
    words.forEach((word, index) => {
      const pair = document.createElement("div");
      pair.className = "word-pair";
      pair.innerHTML = `
      <div class="word-item">${word.text}</div>
      <div class="word-drop" id="drop${
        index + 1
      }" ondrop="dropWord(event)" ondragover="allowDrop(event)"></div>
    `;
      matchingPairsContainer.appendChild(pair);
    });

    // Создаем русские слова для перетаскивания (перемешанные)
    const translations = words.map((word) => word.translation);
    shuffleArray(translations); // Перемешиваем массив

    translations.forEach((translation) => {
      const dragItem = document.createElement("div");
      dragItem.className = "word-item";
      dragItem.draggable = true;
      dragItem.setAttribute("ondragstart", "dragWord(event)");
      dragItem.setAttribute("data-answer", translation);
      dragItem.textContent = translation;
      matchingWordBank.appendChild(dragItem);
    });

    // Добавляем глобальные функции для работы с Drag and Drop
    window.dragWord = function (event) {
      event.dataTransfer.setData(
        "text",
        event.target.getAttribute("data-answer")
      );
      event.dataTransfer.setData("sourceId", event.target.id);
    };

    window.allowDrop = function (event) {
      event.preventDefault();
    };

    window.dropWord = function (event) {
      event.preventDefault();
      const data = event.dataTransfer.getData("text");

      // Если в зоне уже есть элемент, не добавляем новый
      if (event.target.children.length > 0) return;

      // Находим и клонируем перетаскиваемый элемент
      const items = document.querySelectorAll(`[data-answer="${data}"]`);
      if (items.length > 0) {
        const item = items[0].cloneNode(true);
        event.target.innerHTML = "";
        event.target.appendChild(item);

        // Убираем возможность перетаскивания
        item.draggable = false;

        // Удаляем оригинал из банка слов
        items[0].remove();

        // Проверяем, все ли пары сопоставлены
        checkAllMatchesDone();
      }
    };
  }

  // Функция перемешивания массива
  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  // Проверка, все ли пары в сопоставлении заполнены
  function checkAllMatchesDone() {
    const dropZones = document.querySelectorAll(".word-drop");
    const allFilled = Array.from(dropZones).every(
      (zone) => zone.children.length > 0
    );

    if (allFilled) {
      // Если все зоны заполнены, проверяем правильность сопоставления
      validateMatching();
    }
  }

  // Валидация результата сопоставления
  function validateMatching() {
    // Каждая зона должна содержать перевод соответствующего слова
    const pairs = document.querySelectorAll(".word-pair");
    let allCorrect = true;
    let foundIncorrect = false;

    pairs.forEach((pair, index) => {
      const englishWord = pair.querySelector(
        ".word-item:first-child"
      ).textContent;
      const translationContainer = pair.querySelector(".word-drop");
      const translationElement =
        translationContainer.querySelector(".word-item");

      if (!translationElement) return;

      const translation = translationElement.textContent;
      const correctWord = currentWords[index];

      // Проверяем, правильно ли сопоставлено
      if (
        correctWord.text === englishWord &&
        correctWord.translation === translation
      ) {
        translationContainer.classList.add("correct-match");
      } else {
        translationContainer.classList.add("incorrect-match");
        allCorrect = false;
        foundIncorrect = true;
      }
    });

    // Если все пары сопоставлены правильно
    if (allCorrect) {
      // Правильный ответ, начисляем очки и показываем следующий вопрос
      correctAnswers++;
      totalQuestions++;
      score += 10;

      feedbackElement.textContent = `Правильно! +10 очков`;
      feedbackElement.className = "feedback correct";

      // Анимация награды
      showRewardAnimation();

      // Блокируем интерфейс
      disableInputs();

      // Показываем кнопку следующего вопроса
      nextButton.style.display = "block";
    } else if (foundIncorrect) {
      // Если есть неправильные сопоставления
      totalQuestions++;

      feedbackElement.textContent = `Сопоставление выполнено неверно. Попробуйте еще раз!`;
      feedbackElement.className = "feedback incorrect";

      // Сбрасываем сопоставление
      setTimeout(() => {
        setupMatchingGame();
      }, 2000);
    }
  }

  // Переход к следующему вопросу
  function nextQuestion() {
    currentWordIndex++;

    // Если слова закончились, завершаем игру
    if (currentWordIndex >= currentWords.length) {
      finishGame();
    } else {
      // Показываем следующий вопрос
      showCurrentQuestion();
    }
  }

  // Завершение игры и отправка результатов
  async function finishGame() {
    try {
      const response = await fetch("/api/game/end", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          session_id: gameSession,
          score: score,
          correct_answers: correctAnswers,
          total_questions: totalQuestions,
        }),
      });

      const data = await response.json();

      // Обновляем UI с результатами
      feedbackElement.textContent = `Игра завершена! Вы набрали ${score} очков. +${data.experience_gained} к опыту!`;
      feedbackElement.className = "feedback";

      // Скрываем кнопку "Следующий вопрос"
      nextButton.style.display = "none";

      // Обновляем отображение очков и прогресса
      pointsDisplay.textContent =
        parseInt(pointsDisplay.textContent) + data.experience_gained;

      // Если произошло повышение уровня
      if (data.level_up) {
        setTimeout(() => {
          alert(`Поздравляем! Вы достигли уровня ${data.level}!`);
          // Перезагружаем страницу для обновления данных
          window.location.reload();
        }, 1500);
      }

      // Загружаем новую игру через 3 секунды
      setTimeout(() => {
        loadGame(currentGame);
      }, 3000);
    } catch (error) {
      console.error("Ошибка при завершении игры:", error);
    }
  }

  // Анимация для награды
  function showRewardAnimation() {
    const rewardContainer = document.getElementById("reward-animation");

    for (let i = 0; i < 10; i++) {
      const star = document.createElement("div");
      star.className = "stars";
      star.innerHTML = '<i class="fas fa-star"></i>';
      star.style.left = Math.random() * 100 + "vw";
      star.style.animationDelay = Math.random() * 0.5 + "s";
      rewardContainer.appendChild(star);

      // Убрать звезды после анимации
      setTimeout(() => {
        star.remove();
      }, 2000);
    }
  }
</script>
{% endblock %}
