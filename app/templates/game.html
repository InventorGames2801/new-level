{% extends "layout.html" %} {% block title %}New Level - Игровое обучение{%
endblock %} {% block additional_styles %}
<style>
  :root {
    --correct: #4caf50;
    --incorrect: #f44336;
  }
  .game-container {
    margin-top: 100px;
    padding-bottom: 60px;
  }
  .stats-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: white;
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    margin-bottom: 30px;
  }
  .points {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .points-icon {
    color: gold;
    font-size: 24px;
  }
  .points-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--accent);
  }
  .level {
    text-align: center;
  }
  .level-title {
    font-size: 14px;
    color: #777;
    margin-bottom: 5px;
  }
  .level-progress {
    width: 250px;
    height: 10px;
    background-color: #e0e0e0;
    border-radius: 5px;
    overflow: hidden;
  }
  .progress-bar {
    height: 100%;
    background: linear-gradient(to right, var(--secondary), var(--primary));
    border-radius: 5px;
    transition: width 0.3s ease;
  }
  .level-info {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #777;
    margin-top: 5px;
  }
  .game-wrapper {
    background-color: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
    margin-bottom: 30px;
  }
  .game-title {
    text-align: center;
    color: var(--secondary);
    margin-bottom: 20px;
    font-size: 26px;
  }
  .game-selector {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 25px;
  }
  .game-tab {
    background-color: var(--bg-light);
    color: var(--secondary);
    border: none;
    padding: 10px 20px;
    border-radius: 30px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
  }
  .game-tab.active {
    background-color: var(--secondary);
    color: white;
  }
  .game-tab:hover {
    background-color: var(--accent);
    color: white;
  }
  .question-container {
    margin-bottom: 30px;
  }
  .question {
    font-size: 20px;
    margin-bottom: 15px;
    color: #333;
  }
  .scramble-container {
    text-align: center;
    margin-top: 20px;
  }
  .scrambled-word {
    font-size: 28px;
    font-weight: bold;
    color: var(--secondary);
    letter-spacing: 5px;
    margin-bottom: 20px;
  }
  .scramble-input {
    padding: 12px;
    font-size: 18px;
    width: 100%;
    max-width: 300px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 15px;
    text-align: center;
  }
  .scramble-input:focus {
    border-color: var(--primary);
    outline: none;
  }
  .word-pair {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
  }
  .word-drop {
    min-width: 150px;
    min-height: 50px;
    border: 2px dashed var(--secondary);
    border-radius: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.3s ease;
  }
  .word-drop.correct-match {
    border-color: var(--correct);
    background-color: rgba(76, 175, 80, 0.1);
  }
  .word-drop.incorrect-match {
    border-color: var(--incorrect);
    background-color: rgba(244, 67, 54, 0.1);
  }
  .word-item {
    background-color: var(--bg-light);
    padding: 10px 15px;
    border-radius: 5px;
    cursor: move;
    margin: 5px;
    display: inline-block;
    user-select: none;
  }
  .word-bank {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-top: 30px;
  }
  .typing-game input {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    margin-top: 20px;
    margin-bottom: 15px;
  }
  .typing-game input:focus {
    border-color: var(--accent);
    outline: none;
  }
  .check-btn {
    background-color: var(--secondary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: block;
    margin: 0 auto;
  }
  .check-btn:hover {
    background-color: var(--primary);
  }
  .feedback {
    text-align: center;
    margin: 20px 0;
    font-size: 18px;
    font-weight: 600;
    min-height: 27px;
  }
  .next-btn {
    background-color: var(--secondary);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: block;
    margin: 0 auto;
    font-size: 16px;
  }
  .next-btn:hover {
    background-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  .game-info {
    background-color: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
  }
  .game-info h3 {
    color: var(--secondary);
    margin-bottom: 15px;
  }
  .game-info-section {
    margin-bottom: 20px;
  }
  .game-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
  }
  .reward-animation {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 100;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .stars {
    position: absolute;
    font-size: 30px;
    color: gold;
    animation: star-fall 1.5s ease-out forwards;
  }
  @keyframes star-fall {
    0% {
      transform: translateY(-50px) scale(0);
      opacity: 0;
    }
    50% {
      opacity: 1;
      transform: translateY(0) scale(1.2);
    }
    100% {
      transform: translateY(20px) scale(1);
      opacity: 0;
    }
  } /* Скрываем игры по умолчанию */
  #scramble-game,
  #matching-game,
  #typing-game {
    display: none;
  } /* Показываем активную игру */
  .game-active {
    display: block !important;
  } /* Стили для кнопок правильных и неправильных
ответов */
  .correct {
    color: var(--correct);
  }
  .incorrect {
    color: var(--incorrect);
  } /* Стили для кнопок подсказки и пропуска */
  .hint-btn,
  .skip-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    font-size: 14px;
    display: inline-block;
    margin: 0 5px;
  }
  .hint-btn {
    background-color: #fbc02d;
    color: #5d4037;
  }
  .hint-btn:hover {
    background-color: #f9a825;
    transform: translateY(-2px);
  }
  .skip-btn {
    background-color: #e0e0e0;
    color: #555;
  }
  .skip-btn:hover {
    background-color: #bdbdbd;
    transform: translateY(-2px);
  }
  .action-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 15px 0;
  }
</style>
{% endblock %} {% block content %}
<div class="container game-container">
  <div class="stats-bar">
    <div class="points">
      <div class="points-icon">
        <i class="fas fa-star"></i>
      </div>
      <div class="points-value" id="points-display">
        {{ user.total_points }}
      </div>
    </div>

    <div class="level">
      <div class="level-title">ПРОГРЕСС УРОВНЯ</div>
      <div class="level-progress">
        <div
          class="progress-bar"
          id="level-progress-bar"
          style="width: {{ progress_percent }}%;"
        ></div>
      </div>
      <div class="level-info">
        <span>Уровень {{ user.level }}</span>
        <span>Уровень {{ user.level + 1 }}</span>
      </div>
    </div>
  </div>

  <div class="game-wrapper">
    <h2 class="game-title">Игровой центр английского языка</h2>

    <div class="game-selector">
      <button class="game-tab active" data-game="scramble">Анаграммы</button>
      <button class="game-tab" data-game="matching">Сопоставление</button>
      <button class="game-tab" data-game="typing">Написание слов</button>
    </div>

    <div id="scramble-game" class="game-active">
      <div class="question-container">
        <p class="question">
          Расшифруйте английское слово из перемешанных букв:
        </p>

        <div class="scramble-container">
          <div class="scrambled-word" id="scrambled-word">ЗАГРУЗКА...</div>
          <input
            type="text"
            class="scramble-input"
            id="scramble-input"
            placeholder="Введите ответ"
          />
          <button class="check-btn" id="scramble-check-btn">Проверить</button>
        </div>
      </div>
    </div>

    <div id="matching-game">
      <div class="question-container">
        <p class="question">
          Соедините английские слова с их русскими эквивалентами:
        </p>

        <div id="matching-pairs">
          <!-- Сюда будут динамически добавляться пары для сопоставления -->
        </div>

        <div class="word-bank" id="matching-word-bank">
          <!-- Сюда будут динамически добавляться слова для перетаскивания -->
        </div>
      </div>
    </div>

    <div id="typing-game">
      <div class="question-container typing-game">
        <p class="question" id="typing-question">ЗАГРУЗКА...</p>
        <input type="text" id="typing-input" placeholder="Введите слово..." />
        <button class="check-btn" id="typing-check-btn">Проверить</button>
      </div>
    </div>

    <div class="feedback" id="feedback"></div>

    <div class="action-buttons">
      <button id="hint-btn" class="hint-btn">Подсказка</button>
      <button id="skip-btn" class="skip-btn">Пропустить</button>
    </div>

    <button class="next-btn" id="next-btn" style="display: none">
      Следующий вопрос
    </button>
  </div>

  <div class="game-info">
    <div class="game-info-section">
      <h3>Об играх</h3>
      <div class="game-info-grid">
        <div>
          <h4>Анаграммы</h4>
          <p>
            Разгадайте английское слово из перемешанных букв. Тренирует навыки
            орфографии и расширяет словарный запас.
          </p>
        </div>
        <div>
          <h4>Сопоставление</h4>
          <p>
            Перетащите русские слова, чтобы сопоставить их с английскими
            эквивалентами. Отличный способ расширить словарный запас.
          </p>
        </div>
        <div>
          <h4>Написание слов</h4>
          <p>
            Напишите английское слово по его описанию. Развивает навыки
            правописания и ассоциативное мышление.
          </p>
        </div>
      </div>
    </div>

    <div class="game-info-section">
      <h3>Игровая механика</h3>
      <p>
        За каждый правильный ответ вы получаете {{
        settings.points_per_answer|default('10') }} очков. Заработанные очки
        увеличивают ваш прогресс к следующему уровню. Каждый уровень открывает
        новые задания и более сложные слова.
      </p>
      <p>
        Если вам сложно, вы можете использовать подсказку или пропустить вопрос.
        При использовании подсказки в режимах анаграмм и написания слов будет
        показана первая половина слова, а в режиме сопоставления будет
        автоматически установлена одна правильная пара.
      </p>
    </div>
  </div>
</div>

<div class="reward-animation" id="reward-animation"></div>
{% endblock %} {% block scripts %}
<script>
  // Глобальные переменные для игр
  let currentGame = "scramble";
  let gameLoaded = {
    scramble: false,
    matching: false,
    typing: false,
  };
  let currentWords = {
    scramble: [],
    matching: [],
    typing: [],
  };
  let currentWordIndex = {
    scramble: 0,
    matching: 0,
    typing: 0,
  };
  let gameSession = null;
  let score = 0;
  let correctAnswers = 0;
  let totalQuestions = 0;
  let expForLevelUp = 100; // Получим из настроек
  let hintPenalty = 3; // Получим из настроек
  let gamePoints = {
    scramble: 10,
    matching: 15,
    typing: 12,
  }; // Получим из настроек
  let unlimitedAttempts = true; // Получим из настроек
  let showCorrectAnswer = false; // Получим из настроек

  // DOM-элементы - определяем в начале скрипта
  const gameTabs = document.querySelectorAll(".game-tab");
  const gameContainers = document.querySelectorAll(
    "#scramble-game, #matching-game, #typing-game"
  );
  const nextButton = document.getElementById("next-btn");
  const feedbackElement = document.getElementById("feedback");
  const pointsDisplay = document.getElementById("points-display");
  const progressBar = document.getElementById("level-progress-bar");
  const hintBtn = document.getElementById("hint-btn");
  const skipBtn = document.getElementById("skip-btn");

  // Обработчики для игры "Анаграммы"
  const scrambledWordElement = document.getElementById("scrambled-word");
  const scrambleInput = document.getElementById("scramble-input");
  const scrambleCheckBtn = document.getElementById("scramble-check-btn");

  // Обработчики для игры "Написание слов"
  const typingQuestion = document.getElementById("typing-question");
  const typingInput = document.getElementById("typing-input");
  const typingCheckBtn = document.getElementById("typing-check-btn");

  // Загрузка настроек из сервера
  async function loadGameSettings() {
    try {
      const response = await fetch("/api/game/settings");
      if (!response.ok) {
        console.error("Ошибка получения настроек:", response.status);
        return;
      }

      const settings = await response.json();

      // Получаем настройки очков для разных игр
      gamePoints.scramble = parseInt(settings.points_for_scramble || 10);
      gamePoints.matching = parseInt(settings.points_for_matching || 15);
      gamePoints.typing = parseInt(settings.points_for_typing || 12);

      // Другие настройки
      expForLevelUp = parseInt(settings.points_for_level_up || 100);
      hintPenalty = parseInt(settings.hint_penalty || 3);
      unlimitedAttempts = settings.unlimited_attempts === "1";
      showCorrectAnswer = settings.show_correct_answer === "1";

      console.log("Загружены настройки игры:", settings);
    } catch (error) {
      console.error("Ошибка при загрузке настроек:", error);
    }
  }

  // Инициализация при загрузке страницы
  document.addEventListener("DOMContentLoaded", async () => {
    // Загружаем настройки
    await loadGameSettings();

    // Проверяем URL для определения начальной игры
    const params = new URLSearchParams(window.location.search);
    const initialGame = params.get("game") || "scramble";

    if (["scramble", "matching", "typing"].includes(initialGame)) {
      currentGame = initialGame;

      // Активируем соответствующую вкладку
      gameTabs.forEach((tab) => {
        if (tab.dataset.game === initialGame) {
          tab.classList.add("active");
        } else {
          tab.classList.remove("active");
        }
      });

      // Показываем соответствующую игру
      gameContainers.forEach((container) => {
        container.classList.remove("game-active");
      });
      document
        .getElementById(`${initialGame}-game`)
        .classList.add("game-active");
    }

    // Загружаем игру
    loadGame(currentGame);

    // Обработчики событий для кнопок игр
    gameTabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        // Активируем вкладку
        gameTabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");

        const gameType = tab.dataset.game;
        currentGame = gameType;

        // Скрываем все игры и показываем выбранную
        gameContainers.forEach((container) => {
          container.classList.remove("game-active");
        });
        document
          .getElementById(`${gameType}-game`)
          .classList.add("game-active");

        // Загружаем игру только если она еще не загружена
        if (!gameLoaded[gameType]) {
          loadGame(gameType);
        }

        // Обновляем URL для отражения текущей игры
        updateGameUrl(gameType);
      });
    });

    // Обработчик для кнопки "Следующий вопрос"
    nextButton.addEventListener("click", () => {
      nextQuestion();
    });

    // Обработчики для проверки ответов
    if (scrambleCheckBtn) {
      scrambleCheckBtn.addEventListener("click", () => {
        checkScrambleAnswer();
      });
    }

    if (typingCheckBtn) {
      typingCheckBtn.addEventListener("click", () => {
        checkTypingAnswer();
      });
    }

    // Обработка нажатия Enter в полях ввода
    if (scrambleInput) {
      scrambleInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          checkScrambleAnswer();
        }
      });
    }

    if (typingInput) {
      typingInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          checkTypingAnswer();
        }
      });
    }

    // Обработчик для кнопки подсказки
    if (hintBtn) {
      hintBtn.addEventListener("click", () => {
        useHint();
      });
    }

    // Обработчик для кнопки пропуска
    if (skipBtn) {
      skipBtn.addEventListener("click", () => {
        skipQuestion();
      });
    }
  });

  // Функция для обновления URL без перезагрузки страницы
  function updateGameUrl(gameType) {
    const url = new URL(window.location);
    url.searchParams.set("game", gameType);
    window.history.pushState({}, "", url);
  }

  async function startGameSession(gameType) {
    try {
      const response = await fetch("/api/game/start", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ game_type: gameType }),
      });

      if (!response.ok) {
        console.error(`Ошибка API: ${response.status} ${response.statusText}`);
        const errorText = await response.text();
        console.error(errorText);
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();
      gameSession = data.session_id;
      score = 0;
      correctAnswers = 0;
      totalQuestions = 0;

      console.log(`Начата новая игровая сессия: ${gameSession}`);
    } catch (error) {
      console.error("Ошибка при создании игровой сессии:", error);
    }
  }

  // Загрузка слов для игры
  async function loadWordsForGame(gameType) {
    try {
      const count = gameType === "matching" ? 3 : 5;
      console.log(`Fetching ${count} words for game type: ${gameType}`);

      const response = await fetch(`/api/words/${gameType}?count=${count}`);

      if (!response.ok) {
        const errorText = await response.text();
        console.error(`Error response (${response.status}):`, errorText);
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();
      console.log(`Successfully loaded ${data.length} words`);

      return data;
    } catch (error) {
      console.error("Error loading words:", error);
      return [];
    }
  }

  // Загрузка игры
  async function loadGame(gameType) {
    // Сбрасываем UI
    if (feedbackElement) feedbackElement.textContent = "";
    if (feedbackElement) feedbackElement.className = "feedback";
    if (nextButton) nextButton.style.display = "none";
    if (hintBtn) hintBtn.style.display = "block";
    if (skipBtn) skipBtn.style.display = "block";

    // Запускаем новую игровую сессию
    await startGameSession(gameType);

    // Загружаем слова
    currentWords[gameType] = await loadWordsForGame(gameType);
    currentWordIndex[gameType] = 0;
    gameLoaded[gameType] = true;

    // Показываем первый вопрос
    showCurrentQuestion();
  }

  // Показать текущий вопрос
  function showCurrentQuestion() {
    // Проверяем, есть ли слова
    if (!currentWords[currentGame] || currentWords[currentGame].length === 0) {
      console.error("Нет доступных слов для отображения");
      loadGameWords(); // Пытаемся загрузить новые слова
      return;
    }

    // Если текущий индекс выходит за пределы массива, загружаем новые слова
    if (currentWordIndex[currentGame] >= currentWords[currentGame].length) {
      loadGameWords();
      return;
    }

    // Очищаем поля ввода и сообщения
    if (scrambleInput) scrambleInput.value = "";
    if (typingInput) typingInput.value = "";
    if (feedbackElement) feedbackElement.textContent = "";
    if (feedbackElement) feedbackElement.className = "feedback";
    if (nextButton) nextButton.style.display = "none";

    // Разблокируем поля ввода
    if (scrambleInput) scrambleInput.disabled = false;
    if (scrambleCheckBtn) scrambleCheckBtn.disabled = false;
    if (typingInput) typingInput.disabled = false;
    if (typingCheckBtn) typingCheckBtn.disabled = false;

    // Показываем соответствующий вопрос в зависимости от типа игры
    if (currentGame === "scramble" && scrambledWordElement) {
      const word = currentWords[currentGame][currentWordIndex[currentGame]];
      scrambledWordElement.textContent = word.scrambled;
    } else if (currentGame === "matching") {
      setupMatchingGame();
    } else if (currentGame === "typing" && typingQuestion) {
      const word = currentWords[currentGame][currentWordIndex[currentGame]];
      typingQuestion.textContent = word.description;
    }

    // Показываем кнопки
    if (hintBtn) hintBtn.style.display = "block";
    if (skipBtn) skipBtn.style.display = "block";
  }

  // Функция для загрузки новых слов
  async function loadGameWords() {
    try {
      // Показываем индикатор загрузки
      if (feedbackElement) {
        feedbackElement.textContent = "Загрузка новых слов...";
      }

      // Загружаем новые слова для текущей игры
      const newWords = await loadWordsForGame(currentGame);

      // Обновляем массив слов и сбрасываем индекс
      currentWords[currentGame] = newWords;
      currentWordIndex[currentGame] = 0;

      // Показываем новый вопрос
      showCurrentQuestion();
    } catch (error) {
      console.error("Ошибка при загрузке новых слов:", error);
      if (feedbackElement) {
        feedbackElement.textContent =
          "Ошибка при загрузке слов. Попробуйте еще раз.";
        feedbackElement.className = "feedback incorrect";
      }
    }
  }

  // Обработка ответа для игры "Анаграммы"
  function checkScrambleAnswer() {
    if (!scrambleInput) return;

    const word = currentWords[currentGame][currentWordIndex[currentGame]];
    const userAnswer = scrambleInput.value.trim().toLowerCase();

    // Валидация на сервере
    checkAnswer(userAnswer, word.id, "scramble");
  }

  // Обработка ответа для игры "Написание слов"
  function checkTypingAnswer() {
    if (!typingInput) return;

    const word = currentWords[currentGame][currentWordIndex[currentGame]];
    const userAnswer = typingInput.value.trim().toLowerCase();

    // Валидация на сервере
    checkAnswer(userAnswer, word.id, "typing");
  }

  // Общая функция проверки ответа
  async function checkAnswer(userAnswer, wordId, gameType) {
    try {
      const response = await fetch("/api/word/check", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          word_id: wordId,
          answer: userAnswer,
          game_type: gameType,
        }),
      });

      const data = await response.json();

      // Обрабатываем результат
      if (data.correct) {
        // Правильный ответ
        correctAnswers++;
        totalQuestions++;

        // Начисляем очки в зависимости от типа игры
        const points = gamePoints[gameType] || 10;
        score += points;

        if (feedbackElement) {
          feedbackElement.textContent = `Правильно! +${points} очков`;
          feedbackElement.className = "feedback correct";
        }

        // Анимация награды
        showRewardAnimation();

        // Блокируем поля ввода
        disableInputs();

        // Показываем кнопку следующего вопроса
        if (nextButton) nextButton.style.display = "block";

        // Скрываем кнопки подсказки и пропуска
        if (hintBtn) hintBtn.style.display = "none";
        if (skipBtn) skipBtn.style.display = "none";

        // Отправляем обновленные результаты
        updateGameProgress();
      } else {
        // Неправильный ответ
        totalQuestions++;

        // Обрабатываем неправильный ответ
        handleIncorrectAnswer(wordId, gameType);
      }
    } catch (error) {
      console.error("Ошибка при проверке ответа:", error);
    }
  }

  // Функция для обработки неправильного ответа
  function handleIncorrectAnswer(wordId, gameType) {
    // Получаем слово
    const word = currentWords[currentGame][currentWordIndex[currentGame]];

    if (unlimitedAttempts) {
      // Режим неограниченных попыток - показываем сообщение об ошибке, но не блокируем ввод
      if (feedbackElement) {
        feedbackElement.textContent = "Неверно. Попробуйте еще раз!";
        feedbackElement.className = "feedback incorrect";
      }
    } else {
      // Режим ограниченных попыток - показываем правильный ответ, если включена соответствующая настройка
      if (showCorrectAnswer) {
        // Показываем правильный ответ
        let correctAnswer = "";
        if (gameType === "scramble" || gameType === "typing") {
          correctAnswer = word.text;
        } else if (gameType === "matching") {
          correctAnswer = word.translation;
        }

        if (feedbackElement) {
          feedbackElement.textContent = `Неверно. Правильный ответ: ${correctAnswer}`;
          feedbackElement.className = "feedback incorrect";
        }
      } else {
        // Не показываем правильный ответ
        if (feedbackElement) {
          feedbackElement.textContent = "Неверно. Попробуйте следующий вопрос";
          feedbackElement.className = "feedback incorrect";
        }
      }

      // Блокируем поля ввода
      disableInputs();

      // Показываем кнопку следующего вопроса
      if (nextButton) nextButton.style.display = "block";

      // Скрываем кнопки подсказки и пропуска
      if (hintBtn) hintBtn.style.display = "none";
      if (skipBtn) skipBtn.style.display = "none";

      // Отправляем обновленные результаты
      updateGameProgress();
    }
  }

  // Функция для обновления игрового прогресса
  async function updateGameProgress() {
    try {
      const response = await fetch("/api/game/end", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          session_id: gameSession,
          score: score,
          correct_answers: correctAnswers,
          total_questions: totalQuestions,
        }),
      });

      const data = await response.json();

      // Обновляем отображение очков и прогресса, если не достигнут лимит
      if (!data.daily_limit_reached) {
        // Обновляем счетчик очков
        if (pointsDisplay) {
          pointsDisplay.textContent =
            parseInt(pointsDisplay.textContent) + data.experience_gained;
        }

        // Обновляем прогресс-бар
        if (progressBar) {
          const progressPercent = Math.min(
            (data.total_experience / expForLevelUp) * 100,
            100
          );
          progressBar.style.width = `${progressPercent}%`;
        }
      } else {
        // Добавляем информацию о достижении лимита в сообщение обратной связи
        if (feedbackElement) {
          feedbackElement.textContent += ` Достигнут дневной лимит опыта (${data.daily_exp_current}/${data.daily_exp_limit})`;
        }
      }

      // Если произошло повышение уровня
      if (data.level_up) {
        setTimeout(() => {
          alert(`Поздравляем! Вы достигли уровня ${data.level}!`);
          // Перезагружаем страницу для обновления данных
          window.location.reload();
        }, 1500);
      }
    } catch (error) {
      console.error("Ошибка при обновлении прогресса:", error);
    }
  }

  // Использование подсказки
  function useHint() {
    if (
      !currentWords[currentGame] ||
      currentWords[currentGame].length === 0 ||
      currentWordIndex[currentGame] >= currentWords[currentGame].length
    ) {
      return;
    }

    const word = currentWords[currentGame][currentWordIndex[currentGame]];

    if (currentGame === "scramble" && feedbackElement) {
      // Для анаграмм показываем описание в качестве подсказки
      feedbackElement.textContent = `Подсказка: ${word.description}`;
      feedbackElement.className = "feedback";
    } else if (currentGame === "typing" && feedbackElement) {
      // Для написания показываем первые несколько букв
      const hintLength = Math.ceil(word.description.length / 3);
      const hint = word.description.substring(0, hintLength) + "...";
      feedbackElement.textContent = `Подсказка: ${hint}`;
      feedbackElement.className = "feedback";
    } else if (currentGame === "matching" && feedbackElement) {
      // Для сопоставления показываем подсказку
      feedbackElement.textContent =
        "Подсказка: внимательно прочтите описания слов";
      feedbackElement.className = "feedback";
    }

    // Скрываем кнопку подсказки после использования
    if (hintBtn) hintBtn.style.display = "none";

    // Применяем штраф за использование подсказки
    if (hintPenalty > 0) {
      score = Math.max(0, score - hintPenalty);
      if (feedbackElement) {
        feedbackElement.textContent += ` (-${hintPenalty} очков)`;
      }
    }
  }

  // Пропуск вопроса
  function skipQuestion() {
    // Увеличиваем счетчик вопросов
    totalQuestions++;

    // Переходим к следующему вопросу без показа кнопки "следующий вопрос"
    nextQuestion();
  }

  // Функция для блокировки полей ввода
  function disableInputs() {
    if (currentGame === "scramble") {
      if (scrambleInput && !unlimitedAttempts) scrambleInput.disabled = true;
      if (scrambleCheckBtn && !unlimitedAttempts)
        scrambleCheckBtn.disabled = true;
    } else if (currentGame === "typing") {
      if (typingInput && !unlimitedAttempts) typingInput.disabled = true;
      if (typingCheckBtn && !unlimitedAttempts) typingCheckBtn.disabled = true;
    } else if (currentGame === "matching") {
      // Блокируем перетаскивание для режима сопоставления
      if (!unlimitedAttempts) {
        document.querySelectorAll(".word-item").forEach((item) => {
          if (item) item.draggable = false;
        });
      }
    }
  }

  // Переход к следующему вопросу
  function nextQuestion() {
    currentWordIndex[currentGame]++;

    // Если слова закончились, загружаем новые
    if (currentWordIndex[currentGame] >= currentWords[currentGame].length) {
      loadGameWords();
    } else {
      // Показываем следующий вопрос
      showCurrentQuestion();
    }
  }

  // Настройка игры "Сопоставление"
  async function setupMatchingGame() {
    const matchingPairsContainer = document.getElementById("matching-pairs");
    const matchingWordBank = document.getElementById("matching-word-bank");

    if (!matchingPairsContainer || !matchingWordBank) {
      console.error("Не найдены контейнеры для игры Сопоставление");
      return;
    }

    // Очищаем контейнеры
    matchingPairsContainer.innerHTML = "";
    matchingWordBank.innerHTML = "";

    // Проверяем, есть ли слова
    if (!currentWords[currentGame] || currentWords[currentGame].length === 0) {
      console.error("Нет слов для игры Сопоставление");
      return;
    }

    // Получаем слова для сопоставления
    const words = currentWords[currentGame].slice(0, 3); // Используем только 3 пары

    // Создаем пары английское слово - пустая зона для русского
    words.forEach((word, index) => {
      const pair = document.createElement("div");
      pair.className = "word-pair";
      pair.innerHTML = `
      <div class="word-item">${word.text}</div>
      <div class="word-drop" id="drop${index + 1}" data-word-id="${
        word.id
      }" ondrop="dropWord(event)" ondragover="allowDrop(event)"></div>
    `;
      matchingPairsContainer.appendChild(pair);
    });

    // Получаем варианты перевода с сервера
    try {
      const response = await fetch(
        `/api/translation-options?count=${words.length}`
      );
      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const options = await response.json();

      // Перемешиваем варианты для случайного порядка
      shuffleArray(options);

      // Создаем элементы для перетаскивания
      options.forEach((option) => {
        const dragItem = document.createElement("div");
        dragItem.className = "word-item";
        dragItem.draggable = true;
        dragItem.setAttribute("ondragstart", "dragWord(event)");
        dragItem.setAttribute("data-answer", option.text);
        dragItem.textContent = option.text;
        matchingWordBank.appendChild(dragItem);
      });

      // Добавляем глобальные функции для работы с Drag and Drop
      window.dragWord = function (event) {
        event.dataTransfer.setData(
          "text",
          event.target.getAttribute("data-answer")
        );
        event.dataTransfer.setData("sourceId", event.target.id);
      };

      window.allowDrop = function (event) {
        event.preventDefault();
      };

      window.dropWord = function (event) {
        event.preventDefault();
        const data = event.dataTransfer.getData("text");

        // Если в зоне уже есть элемент, не добавляем новый
        if (event.target.children.length > 0) return;

        // Находим и клонируем перетаскиваемый элемент
        const items = document.querySelectorAll(`[data-answer="${data}"]`);
        if (items.length > 0) {
          const item = items[0].cloneNode(true);
          event.target.innerHTML = "";
          event.target.appendChild(item);

          // Убираем возможность перетаскивания
          item.draggable = false;

          // Удаляем оригинал из банка слов
          items[0].remove();

          // Проверяем, все ли пары сопоставлены
          checkAllMatchesDone();
        }
      };
    } catch (error) {
      console.error("Ошибка при получении вариантов перевода:", error);
      if (feedbackElement) {
        feedbackElement.textContent =
          "Ошибка при загрузке вариантов. Попробуйте еще раз.";
        feedbackElement.className = "feedback incorrect";
      }
    }
  }

  // Проверка, все ли пары в сопоставлении заполнены
  function checkAllMatchesDone() {
    const dropZones = document.querySelectorAll(".word-drop");
    if (!dropZones || dropZones.length === 0) return;

    const allFilled = Array.from(dropZones).every(
      (zone) => zone.children.length > 0
    );

    if (allFilled) {
      // Собираем ответы для отправки на сервер
      const answers = [];

      dropZones.forEach((zone) => {
        const wordId = zone.dataset.wordId;
        const answerElement = zone.querySelector(".word-item");

        if (answerElement) {
          answers.push({
            wordId: parseInt(wordId),
            answer: answerElement.textContent,
          });
        }
      });

      // Отправляем ответы на сервер для проверки
      checkMatchingAnswers(answers);
    }
  }

  // Функция для проверки ответов сопоставления на сервере
  async function checkMatchingAnswers(answers) {
    try {
      const response = await fetch("/api/matching/check", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ answers: answers }),
      });

      const result = await response.json();

      // Обрабатываем результаты
      if (result.all_correct) {
        // Все сопоставления верны
        correctAnswers++;
        totalQuestions++;
        score += gamePoints.matching;

        if (feedbackElement) {
          feedbackElement.textContent = `Правильно! +${gamePoints.matching} очков`;
          feedbackElement.className = "feedback correct";
        }

        // Анимация награды
        showRewardAnimation();

        // Отмечаем правильные ответы
        result.results.forEach((item) => {
          const dropZone = document.querySelector(
            `.word-drop[data-word-id="${item.word_id}"]`
          );
          if (dropZone) {
            dropZone.classList.add("correct-match");
          }
        });

        // Блокируем поля ввода
        disableInputs();

        // Показываем кнопку следующего вопроса
        if (nextButton) nextButton.style.display = "block";

        // Скрываем кнопки
        if (hintBtn) hintBtn.style.display = "none";
        if (skipBtn) skipBtn.style.display = "none";

        // Обновляем игровой прогресс
        updateGameProgress();
      } else {
        // Есть неправильные сопоставления
        if (unlimitedAttempts) {
          // В режиме бесконечных попыток просто показываем сообщение
          if (feedbackElement) {
            feedbackElement.textContent =
              "Сопоставление выполнено неверно. Попробуйте еще раз!";
            feedbackElement.className = "feedback incorrect";
          }

          // Подсвечиваем неправильные сопоставления, но не блокируем их
          result.results.forEach((item) => {
            const dropZone = document.querySelector(
              `.word-drop[data-word-id="${item.word_id}"]`
            );
            if (dropZone) {
              if (item.correct) {
                dropZone.classList.add("correct-match");
              } else {
                dropZone.classList.add("incorrect-match");

                // Возвращаем элементы обратно в банк слов для переразмещения
                const wordElement = dropZone.querySelector(".word-item");
                if (wordElement) {
                  const answer = wordElement.textContent;
                  const wordBank =
                    document.getElementById("matching-word-bank");

                  // Создаем новый элемент
                  const newItem = document.createElement("div");
                  newItem.className = "word-item";
                  newItem.draggable = true;
                  newItem.setAttribute("ondragstart", "dragWord(event)");
                  newItem.setAttribute("data-answer", answer);
                  newItem.textContent = answer;

                  // Добавляем в банк слов
                  wordBank.appendChild(newItem);

                  // Удаляем из drop-зоны
                  dropZone.innerHTML = "";
                  dropZone.classList.remove("incorrect-match");
                }
              }
            }
          });
        } else {
          // В режиме ограниченных попыток
          totalQuestions++;

          if (feedbackElement) {
            feedbackElement.textContent = "Сопоставление выполнено неверно.";
            feedbackElement.className = "feedback incorrect";
          }

          // Отмечаем правильные и неправильные ответы
          result.results.forEach((item) => {
            const dropZone = document.querySelector(
              `.word-drop[data-word-id="${item.word_id}"]`
            );
            if (dropZone) {
              if (item.correct) {
                dropZone.classList.add("correct-match");
              } else {
                dropZone.classList.add("incorrect-match");

                // Если нужно показывать правильный ответ
                if (showCorrectAnswer) {
                  // Получаем слово
                  const word = currentWords[currentGame].find(
                    (w) => w.id === item.word_id
                  );
                  if (word) {
                    // Очищаем зону
                    dropZone.innerHTML = "";

                    // Создаем правильный элемент
                    const correctElement = document.createElement("div");
                    correctElement.className = "word-item";
                    correctElement.textContent = word.translation;
                    correctElement.style.border = "2px solid green";

                    // Добавляем в drop-зону
                    dropZone.appendChild(correctElement);
                  }
                }
              }
            }
          });

          // Блокируем интерфейс
          disableInputs();

          // Показываем кнопку следующего вопроса
          if (nextButton) nextButton.style.display = "block";

          // Скрываем кнопки
          if (hintBtn) hintBtn.style.display = "none";
          if (skipBtn) skipBtn.style.display = "none";

          // Обновляем игровой прогресс
          updateGameProgress();
        }
      }
    } catch (error) {
      console.error("Ошибка при проверке сопоставлений:", error);
    }
  }

  // Функция перемешивания массива
  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  // Анимация для награды
  function showRewardAnimation() {
    const rewardContainer = document.getElementById("reward-animation");
    if (!rewardContainer) return;

    for (let i = 0; i < 10; i++) {
      const star = document.createElement("div");
      star.className = "stars";
      star.innerHTML = '<i class="fas fa-star"></i>';
      star.style.left = Math.random() * 100 + "vw";
      star.style.animationDelay = Math.random() * 0.5 + "s";
      rewardContainer.appendChild(star);

      // Убрать звезды после анимации
      setTimeout(() => {
        star.remove();
      }, 2000);
    }
  }
</script>
{% endblock %}
